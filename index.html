<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Br√∫jula de Mentor√≠a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=Literata:opsz,wght@7..72,500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* ‚îÄ‚îÄ Paleta principal ‚îÄ‚îÄ */
      --navy-950: #0c1d33;
      --navy-800: #102645;
      --navy-600: #173a63;
      --navy-400: #0f4c81;
      --navy-50:  #edf5ff;

      /* ‚îÄ‚îÄ Paleta secundaria ‚îÄ‚îÄ */
      --coral-500: #d26a5c;
      --coral-50:  #fdf0ee;

      /* ‚îÄ‚îÄ Sistema Ink ‚îÄ‚îÄ */
      --ink-900: #17223b;
      --ink-700: #2b3857;
      --ink-500: #4e5d7a;
      --ink-200: #cdd5e4;
      --ink-50:  #f4f7fc;

      /* ‚îÄ‚îÄ Superficies ‚îÄ‚îÄ */
      --bg-soft: #edf2f7;
      --card:    #ffffff;
      --line:    var(--ink-200);

      /* ‚îÄ‚îÄ Aliases funcionales ‚îÄ‚îÄ */
      --accent:   var(--navy-400);
      --accent-2: var(--coral-500);

      /* ‚îÄ‚îÄ Estados ‚îÄ‚îÄ */
      --state-success:    #1a7f5a;
      --state-success-bg: #e8f8f2;
      --state-error:      #b42318;
      --state-error-bg:   #fef2f2;
      --state-focus:      #78b0e8;
      --state-disabled:   #b8c5d6;

      /* ‚îÄ‚îÄ Espacial (base 4px) ‚îÄ‚îÄ */
      --space-1:  4px;
      --space-2:  8px;
      --space-3:  12px;
      --space-4:  16px;
      --space-5:  20px;
      --space-6:  24px;
      --space-8:  32px;

      /* ‚îÄ‚îÄ Radio ‚îÄ‚îÄ */
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --radius-xl: 26px;

      /* ‚îÄ‚îÄ Tipograf√≠a ‚îÄ‚îÄ */
      --text-xs:   11px;
      --text-sm:   13px;
      --text-base: 15px;
      --text-md:   17px;
      --text-lg:   21px;
      --text-xl:   27px;
      --text-2xl:  34px;
      --text-3xl:  42px;

      /* ‚îÄ‚îÄ Motion ‚îÄ‚îÄ */
      --ease-out:    cubic-bezier(0.16, 1, 0.3, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --dur-fast:    150ms;
      --dur-base:    250ms;
      --dur-slow:    400ms;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Sora', sans-serif;
      color: var(--ink-900);
      background:
        radial-gradient(circle at 8% 12%, rgba(210, 106, 92, 0.16), transparent 35%),
        radial-gradient(circle at 88% 20%, rgba(15, 76, 129, 0.18), transparent 40%),
        linear-gradient(145deg, #f8fbff 0%, var(--bg-soft) 100%);
      padding: 20px;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.92));
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: 26px;
      box-shadow: 0 30px 70px rgba(16, 28, 48, 0.15);
      overflow: hidden;
      position: relative;
    }

    .shell::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(205, 213, 228, 0.16) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(205, 213, 228, 0.14) 1px, transparent 1px);
      background-size: 26px 26px;
      pointer-events: none;
      mask-image: linear-gradient(to bottom, rgba(0,0,0,0.42), transparent 70%);
    }

    .content { position: relative; z-index: 2; padding: 28px; }

    /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
    .hero {
      background: linear-gradient(132deg, #102645 0%, #173a63 60%, #24507f 100%);
      color: #f4f8ff;
      border-radius: 18px;
      padding: 24px 26px;
      margin-bottom: 18px;
      animation: fadeUp .5s ease-out;
    }

    .eyebrow {
      font-family: 'Literata', serif;
      letter-spacing: .5px;
      font-size: 11px;
      text-transform: uppercase;
      opacity: .7;
      margin: 0 0 10px;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 5vw, 40px);
      line-height: 1.08;
      letter-spacing: -0.5px;
    }

    .sub {
      margin: 10px 0 0;
      color: #cfdff8;
      font-size: clamp(14px, 2vw, 16px);
      max-width: 66ch;
      line-height: 1.55;
    }

    .time-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 14px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 99px;
      padding: 4px 12px;
      font-size: 12px;
      color: #c0d8f6;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 20px;
      animation: fadeUp .55s ease-out;
    }

    .panel-heading {
      font-size: 17px;
      font-weight: 700;
      color: var(--ink-700);
      margin: 0 0 3px;
    }

    .panel-sub {
      font-size: 13px;
      color: var(--ink-500);
      margin: 0 0 16px;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ STAGE CARDS ‚îÄ‚îÄ */
    .stage-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .stage-card {
      text-align: left;
      border: 1.5px solid #d3dceb;
      background: linear-gradient(160deg, #fbfdff, #f2f6fc);
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }

    .stage-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 22px rgba(23, 34, 59, 0.09);
    }

    .stage-card[aria-pressed="true"] {
      border-color: var(--accent);
      background: linear-gradient(160deg, #edf5ff, #dfeefa);
      box-shadow: 0 0 0 2.5px rgba(15, 76, 129, 0.18);
    }

    .stage-card:focus-visible {
      outline: 3px solid #78b0e8;
      outline-offset: 2px;
    }

    .stage-icon {
      font-size: 28px;
      line-height: 1;
      margin-bottom: 10px;
      display: block;
    }

    .stage-card h3 {
      margin: 0 0 5px;
      font-size: 17px;
      letter-spacing: -0.2px;
      color: var(--ink-900);
    }

    .stage-card p {
      margin: 0;
      color: var(--ink-500);
      line-height: 1.42;
      font-size: 13px;
    }

    .profile-snapshot {
      background: #f7faff;
      border: 1px solid #d8e6fb;
      border-radius: 10px;
      padding: 12px 14px;
      margin: 0 0 14px;
      display: none;
    }
    .profile-snapshot p {
      margin: 0 0 6px;
      font-size: 12px;
      font-weight: 700;
      color: #274472;
    }
    .profile-snapshot ul {
      margin: 0;
      padding-left: 18px;
      color: #334155;
      font-size: 13px;
      line-height: 1.35;
    }

    /* ‚îÄ‚îÄ CTA (welcome) ‚îÄ‚îÄ */
    .cta {
      margin-top: 18px;
      width: 100%;
      border: none;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--accent), #1f659e);
      color: #fff;
      font-size: 16px;
      font-weight: 800;
      padding: 15px 16px;
      cursor: pointer;
      transition: filter .2s ease, transform .2s ease;
      letter-spacing: 0.15px;
    }

    .cta:hover { transform: translateY(-1px); filter: brightness(1.06); }

    .cta:disabled {
      cursor: not-allowed;
      background: #b8c5d6;
      color: #eef3fb;
      transform: none;
      filter: none;
    }

    .cta:focus-visible { outline: 3px solid #78b0e8; outline-offset: 3px; }

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .progress-tools {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .progress-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .progress-track {
      flex: 1;
      height: 7px;
      border-radius: 999px;
      background: #dde5f0;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--accent-2), var(--accent));
      transition: width .38s ease;
      border-radius: 999px;
    }

    .progress-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink-500);
      white-space: nowrap;
      min-width: 86px;
      text-align: right;
    }
    .link-btn {
      border: 1.5px solid #b0c4dc;
      background: #eef3fb;
      color: #29486b;
      border-radius: 999px;
      height: 36px;
      padding: 0 14px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Sora', sans-serif;
    }
    .link-btn:focus-visible { outline: 3px solid #78b0e8; outline-offset: 2px; }

    /* ‚îÄ‚îÄ QUESTION ‚îÄ‚îÄ */
    .question-title {
      font-size: clamp(19px, 2.8vw, 27px);
      line-height: 1.28;
      margin: 0 0 16px;
      color: var(--ink-900);
      letter-spacing: -0.2px;
    }

    .answer-list {
      display: grid;
      gap: 8px;
    }

    .answer-btn {
      border: 1.5px solid #c9d4e7;
      background: #fff;
      border-radius: 12px;
      padding: 13px 15px;
      text-align: left;
      font-size: 15px;
      line-height: 1.38;
      color: var(--ink-700);
      cursor: pointer;
      font-family: 'Sora', sans-serif;
      opacity: 0;
      animation: staggerIn .25s ease-out forwards;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease, transform .15s ease;
    }

    .answer-btn:hover {
      border-color: #8da8c8;
      box-shadow: 0 6px 16px rgba(25, 40, 65, 0.07);
      transform: translateX(3px);
    }

    .answer-btn[aria-pressed="true"] {
      border-color: var(--accent);
      background: #e8f2ff;
      color: #0b2e52;
      box-shadow: 0 0 0 2px rgba(15, 76, 129, 0.18);
      font-weight: 600;
    }

    .answer-btn:focus-visible { outline: 3px solid #78b0e8; outline-offset: 1px; }

    /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
    .nav {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .ghost,
    .primary {
      border-radius: 10px;
      padding: 10px 18px;
      font-weight: 700;
      border: none;
      min-width: 110px;
      font-size: 15px;
      cursor: pointer;
      font-family: 'Sora', sans-serif;
      transition: filter .15s, background .15s, transform .15s;
    }

    .ghost {
      background: #eef3fb;
      color: #324767;
    }

    .ghost:hover { background: #e0eaf5; }
    .ghost:focus-visible { outline: 3px solid #78b0e8; outline-offset: 1px; }

    .primary {
      background: linear-gradient(90deg, var(--accent), #2169a2);
      color: #fff;
    }

    .primary:hover { filter: brightness(1.07); }
    .primary:focus-visible { outline: 3px solid #78b0e8; outline-offset: 1px; }

    .primary:disabled {
      background: #b5c2d3;
      color: #f0f4fb;
      cursor: not-allowed;
      filter: none;
    }

    /* ‚îÄ‚îÄ STATUS BOXES ‚îÄ‚îÄ */
    .status-box {
      text-align: center;
      padding: 36px 24px 32px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      animation: fadeUp .5s ease-out;
    }

    .status-icon {
      font-size: 48px;
      line-height: 1;
      margin-bottom: 14px;
      display: block;
    }

    .status-box h2 {
      margin: 0 0 8px;
      font-size: clamp(21px, 3.4vw, 30px);
      color: var(--ink-900);
      letter-spacing: -0.3px;
    }
    .result-meta {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0 10px;
    }

    .scenario-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #edf5ff;
      border: 1px solid #c0d8f4;
      border-radius: 99px;
      padding: 5px 14px;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      margin: 0;
    }

    .score-ring {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      background: linear-gradient(135deg, #edf5ff, #dde8fa);
      border: 2px solid #b8d5f2;
      font-size: 16px;
      font-weight: 800;
      color: var(--accent);
      margin: 0;
    }
    .result-copy-main {
      font-size: 18px;
      color: var(--ink-700);
      font-weight: 600;
      margin-top: 6px;
      line-height: 1.45;
    }
    .result-footnote {
      margin-top: 10px;
      font-size: 14px;
    }
    .office-note {
      margin-top: 8px;
      font-size: 13px;
      color: var(--ink-500);
      line-height: 1.45;
    }
    .office-callout {
      margin: 12px auto 0;
      max-width: 560px;
      background: #ecfdf3;
      border: 1px solid #99f6b8;
      border-radius: 12px;
      padding: 10px 14px;
      color: #166534;
      font-size: 14px;
      line-height: 1.45;
      font-weight: 700;
    }
    .data-note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--ink-500);
      line-height: 1.55;
    }
    .data-note a {
      color: var(--accent);
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .status-box p {
      color: var(--ink-500);
      margin: 6px auto 0;
      font-size: 15px;
      line-height: 1.55;
      max-width: 52ch;
    }

    .mentor-cta {
      display: inline-block;
      margin-top: 16px;
      background: linear-gradient(90deg, var(--accent), #2169a2);
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      padding: 11px 22px;
      font-weight: 700;
      font-size: 15px;
      font-family: 'Sora', sans-serif;
      transition: filter .2s, transform .2s;
    }

    .mentor-cta:hover { filter: brightness(1.07); transform: translateY(-1px); }
    .mentor-cta:focus-visible { outline: 3px solid #78b0e8; outline-offset: 3px; }
    .cta-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .mentor-cta.secondary {
      background: #eef4ff;
      color: var(--accent);
      border: 1px solid #b8d5f2;
    }
    .done-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e8f8f2;
      color: #166534;
      border: 1px solid #9fe3be;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      margin: 2px 0 10px;
    }

    /* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #d4e3f5;
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 20px auto 0;
      animation: spin 1s linear infinite;
    }

    .spinner-label {
      font-size: 13px;
      color: var(--ink-500);
      margin-top: 10px;
      font-style: normal;
    }
    .loading-cta {
      margin-top: 12px;
      display: inline-block;
      color: var(--accent);
      font-weight: 700;
      text-decoration: none;
      font-size: 14px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(12, 29, 51, 0.46);
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal-card {
      width: 100%;
      max-width: 440px;
      background: #fff;
      border: 1px solid #cfdaea;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 18px 44px rgba(9, 22, 40, 0.25);
    }
    .modal-title {
      margin: 0 0 8px;
      font-size: 20px;
      color: var(--ink-900);
    }
    .modal-copy {
      margin: 0;
      color: var(--ink-500);
      font-size: 14px;
      line-height: 1.45;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 14px;
    }

    /* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
    .hidden { display: none !important; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes staggerIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .content { padding: 14px; }
      .hero { padding: 16px 18px; border-radius: 14px; }
      .stage-grid { grid-template-columns: 1fr; }
      .stage-card h3 { font-size: 16px; }
      .cta { font-size: 15px; padding: 13px; }
      .status-box { padding: 26px 16px 24px; }
      .mentor-cta { width: 100%; text-align: center; }
      .cta-group { gap: 8px; }
      .progress-tools { min-width: 130px; justify-content: flex-end; }
      .progress-label { min-width: auto; font-size: 10px; }
      .result-meta { display: flex; justify-content: center; width: 100%; }
    }

    @media (max-width: 400px) {
      .ghost, .primary { min-width: 90px; font-size: 14px; padding: 9px 12px; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <div class="content">

      <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ -->
      <section class="hero" aria-label="Encabezado">
        <p class="eyebrow">Mentor√≠a Estudiantil ¬∑ Tec de Monterrey</p>
        <h1>Br√∫jula de avance estudiantil</h1>
        <p id="hero-copy" class="sub"></p>
        <div class="time-badge" aria-label="Duraci√≥n estimada: menos de 2 minutos, sin respuestas incorrectas">
          <span aria-hidden="true">‚è±</span> 2 min ¬∑ Sin respuestas incorrectas
        </div>
      </section>

      <!-- ‚îÄ‚îÄ WELCOME STATE ‚îÄ‚îÄ -->
      <section id="welcome-state" class="panel" aria-label="Selecci√≥n de etapa">
        <p class="panel-heading">¬øD√≥nde est√°s hoy?</p>
        <p class="panel-sub">No hay respuesta correcta. Elige la opci√≥n que m√°s se parece a tu momento.</p>
        <p id="attempt-copy" class="panel-sub" style="margin-top:6px; font-size:13px; color:#4f5f7e;"></p>
        <div id="profile-snapshot" class="profile-snapshot">
          <p>Datos de referencia de tu expediente</p>
          <ul id="profile-snapshot-list"></ul>
        </div>

        <div class="stage-grid" role="group" aria-label="Etapas disponibles">
          <button class="stage-card" data-stage="exploracion" type="button"
                  aria-pressed="false" aria-describedby="desc-exploracion">
            <span class="stage-icon" aria-hidden="true">üß≠</span>
            <h3>Exploraci√≥n</h3>
            <p id="desc-exploracion">Semestres iniciales, por elegir carrera de egreso y fortalecer h√°bitos para aprovechar mejor tu experiencia en el Tec.</p>
          </button>
          <button class="stage-card" data-stage="enfoque" type="button"
                  aria-pressed="false" aria-describedby="desc-enfoque">
            <span class="stage-icon" aria-hidden="true">üéØ</span>
            <h3>Enfoque</h3>
            <p id="desc-enfoque">Ya elegiste carrera de egreso, exploras opciones de Semestre Tec y buscas potenciar tu trayectoria.</p>
          </button>
        </div>

        <button id="start-btn" class="cta" disabled aria-label="Iniciar mi diagn√≥stico de mentor√≠a">
          Iniciar mi diagn√≥stico ‚Üí
        </button>
        <p class="data-note">
          Uso de datos estrictamente institucional para mentor√≠a estudiantil, acompa√±amiento de trayectoria acad√©mica y cuidado del bienestar.
          Consulta el
          <a id="privacy-link" href="https://tec.mx/es/aviso-de-privacidad-alumnos" target="_blank" rel="noopener noreferrer">aviso de privacidad para alumnos</a>.
        </p>
        <p class="data-note" style="margin-top:6px;">
          Si aparece un aviso de Google Apps Script al abrir el enlace, es normal. Da clic en continuar.
        </p>
      </section>

      <!-- ‚îÄ‚îÄ QUIZ STATE ‚îÄ‚îÄ -->
      <section id="quiz-state" class="panel hidden" aria-label="Test de diagn√≥stico">
        <div class="progress-wrap">
          <div class="progress-track"
               role="progressbar"
               aria-valuemin="0"
               aria-valuemax="100"
               aria-valuenow="0"
               id="progress-bar-wrap"
               aria-label="Progreso del test">
            <div id="progress-bar" class="progress-bar"></div>
          </div>
          <div class="progress-tools">
            <span id="progress-label" class="progress-label" aria-live="polite" aria-atomic="true"></span>
          </div>
        </div>
        <div class="progress-actions">
          <button id="change-stage-btn" class="link-btn" type="button" aria-label="Volver y cambiar etapa">
            ‚Ü© Volver y cambiar etapa
          </button>
        </div>

        <div id="question-container"></div>

        <div class="nav">
          <button id="prev-btn" class="ghost" type="button" aria-label="Volver a la pregunta anterior">
            ‚Üê Atr√°s
          </button>
          <button id="next-btn" class="primary" type="button" disabled aria-label="Ir a la pregunta siguiente">
            Siguiente ‚Üí
          </button>
        </div>
      </section>

      <!-- ‚îÄ‚îÄ FINAL STATE ‚îÄ‚îÄ -->
      <section id="final-state" class="status-box hidden"
               aria-label="Resultados del diagn√≥stico" aria-live="polite">
        <!-- Loading -->
        <div id="final-loading">
          <div class="spinner" role="status" aria-label="Procesando tus respuestas"></div>
          <p class="spinner-label">Procesando tus respuestas‚Ä¶</p>
          <a id="loading-whatsapp-link" href="https://wa.me/5218128612913" target="_blank" rel="noopener noreferrer" class="loading-cta">
            Agenda desde ahora con tu mentora ‚Üí
          </a>
        </div>

        <!-- Results (shown after server responds) -->
        <div id="final-content" class="hidden">
          <span class="status-icon" aria-hidden="true">üß≠</span>
          <h2 id="final-title" tabindex="-1">Aqu√≠ est√° tu panorama</h2>
          <div class="result-meta">
            <div id="scenario-chip" class="scenario-chip"></div>
            <div id="score-ring" class="score-ring" aria-label="Puntaje total"></div>
          </div>
          <p id="result-copy" class="result-copy-main"></p>
          <a href="https://calendly.com/karenkrei/charla-1-a-1"
             target="_blank" rel="noopener noreferrer"
             class="mentor-cta"
             aria-label="Abrir Calendly para agendar sesi√≥n con tu mentora">
            Agenda tu sesi√≥n ‚Üí
          </a>
          <p class="office-callout">O acude al Open Office: jueves 9:30 a 16:00, Centrales Sur 3er piso. Av√≠same por WhatsApp antes de pasar.</p>
          <p class="result-footnote">Te enviamos un resumen al correo.</p>
        </div>

        <!-- Error -->
        <p id="error-message" class="hidden"
           role="alert"
           style="color:#b42318; font-weight:700; margin-top:16px; font-size:15px;">
          Algo sali√≥ mal al guardar. Recarga la p√°gina e intenta de nuevo, o escr√≠bele directamente a tu mentora.
        </p>
      </section>

      <!-- ‚îÄ‚îÄ ALREADY STATE ‚îÄ‚îÄ -->
      <section id="already-state" class="status-box hidden"
               aria-label="Diagn√≥stico previo encontrado">
        <span class="status-icon" aria-hidden="true">üìå</span>
        <p class="done-pill" aria-label="Br√∫jula completada">‚úÖ Ya completaste tu Br√∫jula</p>
        <h2>Ya tenemos tu punto de partida</h2>
        <div id="already-chip" class="scenario-chip"></div>
        <div id="already-score" class="score-ring" aria-label="Puntaje previo"></div>
        <p id="already-copy"></p>
        <p>Tu mentora ya puede ver tu perfil. El siguiente paso es conversar para definir acciones concretas.</p>
        <div class="cta-group">
          <a id="already-calendly-link" href="https://calendly.com/karenkrei/charla-1-a-1"
             target="_blank" rel="noopener noreferrer"
             class="mentor-cta"
             aria-label="Abrir Calendly para agendar cita uno a uno">
            Agendar cita 1 a 1 ‚Üí
          </a>
          <a id="already-whatsapp-link" href="https://wa.me/5218128612913"
             target="_blank" rel="noopener noreferrer"
             class="mentor-cta secondary"
             aria-label="Abrir WhatsApp para contactar a tu mentora">
            Contactar a mi mentora ‚Üí
          </a>
        </div>
        <p class="office-note">Open Office todos los jueves, 9:30 a 16:00, Centrales Sur 3er piso. Av√≠same por WhatsApp antes de pasar.</p>
      </section>

      <div id="change-stage-modal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="change-stage-title">
        <div class="modal-card">
          <h3 id="change-stage-title" class="modal-title">¬øCambiar etapa?</h3>
          <p class="modal-copy">Si cambias de etapa se perder√°n tus respuestas actuales.</p>
          <div class="modal-actions">
            <button id="change-stage-cancel" class="ghost" type="button">No, seguir</button>
            <button id="change-stage-confirm" class="primary" type="button">S√≠, cambiar</button>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    /* ‚îÄ‚îÄ DATA FROM GAS TEMPLATE ‚îÄ‚îÄ */
    const student          = { email: "<?= email ?>", name: "<?= name ?>" };
    const questionBank     = <?= questionBankJson ?>;
    const previousResponse = <?= previousResponseJson ?>;
    const responseStats    = <?= responseStatsJson ?>;
    const studentProfile   = <?= studentProfileJson ?>;
    const whatsappLink     = <?= whatsappLinkJson ?>;
    const whatsappResultLink = <?= whatsappResultLinkJson ?>;
    const privacyPolicyUrl = <?= privacyPolicyUrlJson ?>;

    /* ‚îÄ‚îÄ DOM REFS ‚îÄ‚îÄ */
    const welcomeState      = document.getElementById('welcome-state');
    const quizState         = document.getElementById('quiz-state');
    const finalState        = document.getElementById('final-state');
    const alreadyState      = document.getElementById('already-state');
    const startBtn          = document.getElementById('start-btn');
    const progressBar       = document.getElementById('progress-bar');
    const progressBarWrap   = document.getElementById('progress-bar-wrap');
    const progressLabel     = document.getElementById('progress-label');
    const questionContainer = document.getElementById('question-container');
    const prevBtn           = document.getElementById('prev-btn');
    const nextBtn           = document.getElementById('next-btn');
    const changeStageBtn    = document.getElementById('change-stage-btn');
    const finalLoading      = document.getElementById('final-loading');
    const finalContent      = document.getElementById('final-content');
    const errorMessage      = document.getElementById('error-message');
    const resultCopy        = document.getElementById('result-copy');
    const alreadyCopy       = document.getElementById('already-copy');
    const attemptCopy       = document.getElementById('attempt-copy');
    const profileSnapshot   = document.getElementById('profile-snapshot');
    const profileSnapshotList = document.getElementById('profile-snapshot-list');
    const heroCopy          = document.getElementById('hero-copy');
    const scenarioChip      = document.getElementById('scenario-chip');
    const scoreRing         = document.getElementById('score-ring');
    const alreadyChip       = document.getElementById('already-chip');
    const alreadyScore      = document.getElementById('already-score');
    const finalTitle        = document.getElementById('final-title');
    const changeStageModal  = document.getElementById('change-stage-modal');
    const modalCancelBtn    = document.getElementById('change-stage-cancel');
    const modalConfirmBtn   = document.getElementById('change-stage-confirm');
    const loadingWhatsappLink = document.getElementById('loading-whatsapp-link');
    const alreadyWhatsappLink = document.getElementById('already-whatsapp-link');
    const alreadyCalendlyLink = document.getElementById('already-calendly-link');
    const privacyLink         = document.getElementById('privacy-link');

    /* ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ */
    const SCENARIO_LABELS = {
      'Consolidado': '‚≠ê Nivel avanzado',
      'Desarrollo':  'üìà En buen avance',
      'Oportunidad': 'üå± Con potencial claro'
    };

    const SCENARIO_MESSAGES = {
      'Consolidado': 'Vas muy bien. La mentor√≠a ahora sirve para escalar, no para recuperar terreno.',
      'Desarrollo':  'Tienes buena base. Hay uno o dos puntos donde una conversaci√≥n directa con tu mentora hace diferencia real.',
      'Oportunidad': 'Hay √°reas prioritarias donde la orientaci√≥n correcta ahorra tiempo valioso. Tu mentora ya tiene tu perfil.'
    };

    /* Maps stage ‚Üí stageContext value expected by the GAS sheet.
       Eliminates the redundant confirmation dropdown. */
    const STAGE_CONTEXT_MAP = {
      exploracion: 'avenida',
      enfoque:     'carrera_definida'
    };

    if (loadingWhatsappLink) loadingWhatsappLink.href = whatsappResultLink || whatsappLink;
    if (alreadyWhatsappLink) alreadyWhatsappLink.href = whatsappResultLink || whatsappLink;
    if (alreadyCalendlyLink) alreadyCalendlyLink.href = 'https://calendly.com/karenkrei/charla-1-a-1';
    if (privacyLink) privacyLink.href = privacyPolicyUrl;

    /* ‚îÄ‚îÄ HERO GREETING ‚îÄ‚îÄ */
    const normalizedName = (student.name || '').trim();
    const fallbackName   = (student.email || '').split('@')[0] || 'estudiante';
    const displayName    = normalizedName || fallbackName;
    heroCopy.textContent = `Hola, ${displayName}. Esta br√∫jula te ayuda a reflexionar sobre tu avance y definir tu siguiente paso con apoyo de tu mentora.`;

    /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
    const FALLBACK_QUESTION_BANK = {
      exploracion: [
        {
          key: 'claridad_carrera',
          title: 'üéì ¬øQu√© tan claro tienes la carrera que quieres elegir y tu proceso para decidir?',
          options: [
            'Nada claro, necesito orientaci√≥n.',
            'Tengo algunas ideas, pero sigo confundido/a.',
            'Estoy explorando opciones (cursos, talleres o asesor√≠a).',
            'Tengo casi decidido mi camino.',
            'Estoy totalmente seguro/a de mi elecci√≥n.'
          ]
        },
        {
          key: 'desempeno_academico',
          title: 'üìö ¬øC√≥mo eval√∫as tu desempe√±o acad√©mico y tu promedio actual?',
          options: [
            'Me siento insatisfecho/a con mi promedio.',
            'Mi promedio no refleja mi esfuerzo.',
            'Estoy en un promedio aceptable, pero quiero mejorar.',
            'Estoy satisfecho/a con mi desempe√±o.',
            'Mi promedio es excelente y constante.'
          ]
        },
        {
          key: 'plan_practicas',
          title: 'üíº ¬øQu√© tanto sabes sobre c√≥mo y d√≥nde buscar tus primeras pr√°cticas profesionales?',
          options: [
            'No s√© nada a√∫n sobre pr√°cticas.',
            'He escuchado algo, pero no tengo claro el proceso.',
            'Estoy investigando opciones y requisitos.',
            'Ya identifiqu√© oportunidades concretas.',
            'Estoy por aplicar o ya apliqu√© a pr√°cticas.'
          ]
        },
        {
          key: 'servicio_social',
          title: 'ü§ù ¬øQu√© tan claro tienes tu plan para completar tus 480h de servicio social?',
          options: [
            'No he pensado en el servicio social.',
            'S√© que es requisito, pero no tengo plan.',
            'Estoy revisando opciones o proyectos.',
            'Ya tengo una opci√≥n identificada.',
            'Estoy inscrito/a y avanzando en horas.'
          ]
        }
      ],
      enfoque: [
        {
          key: 'servicio_social',
          title: 'ü§ù Antes de cursar tu Semestre Tec, necesitas haber completado tus 480 horas de Servicio Social. ¬øCu√°l es tu estatus actual?',
          options: [
            'No tengo claro cu√°ndo lo terminar√©, ni s√© cu√°ntas horas me faltan.',
            'Tengo un plan, pero me preocupa no terminar antes de mi Semestre Tec.',
            'Tengo pensado terminarlo en el pr√≥ximo periodo intensivo (verano o invierno).',
            'Estoy en mi √∫ltimo proyecto y tengo planeado terminarlo este semestre.',
            '¬°Misi√≥n cumplida! Ya cumpl√≠ mis 480 horas o m√°s.'
          ]
        },
        {
          key: 'decision_semestre_tec',
          title: '‚úàÔ∏è ¬øQu√© tan definida tienes tu elecci√≥n para tu(s) Semestre(s) Tec (intercambio, pr√°cticas, concentraci√≥n)?',
          options: [
            'Tengo algunas ideas generales, pero realmente no s√© por d√≥nde empezar a decidir.',
            'Ya estoy investigando, pero a√∫n no he definido una opci√≥n clara.',
            'Tengo solo 1 opci√≥n considerada; si no funciona, no sabr√≠a qu√© elegir.',
            'Tengo al menos 3 alternativas que me gustan y planeo reunirme con mi Director de Programa para validarlas.',
            'Ya tengo 5 opciones bien estudiadas, me siento informado/a y ya lo valid√© con mi Director/a de Programa.'
          ]
        },
        {
          key: 'certificacion_idioma',
          title: 'üåç Si consideras un intercambio, ¬øcu√°l es tu estatus con el examen de certificaci√≥n de idioma (ingl√©s, franc√©s, alem√°n, etc.)?',
          options: [
            'No estoy considerando un intercambio / No estoy seguro/a de qu√© examen o puntaje necesito para los destinos que me interesan.',
            'S√© lo que necesito, pero no he comenzado a prepararme formalmente.',
            'Estoy prepar√°ndome para un idioma distinto al ingl√©s (ej. franc√©s, alem√°n) que es requisito.',
            'Me siento listo/a para presentar el examen, pero a√∫n no he agendado una fecha.',
            '¬°Listo! Ya tengo mi certificado vigente con el puntaje necesario para mis opciones de intercambio.'
          ]
        },
        {
          key: 'plan_practicas',
          title: 'üíº Si tuvieras que aplicar a tus pr√°cticas profesionales so√±adas hoy mismo, ¬øqu√© tan preparado/a te sentir√≠as?',
          options: [
            'No me sentir√≠a preparado/a; no he comenzado a adaptar mi CV ni he explorado empresas.',
            'Tengo un CV b√°sico, pero necesitar√≠a mucho trabajo para adaptarlo y no he buscado activamente.',
            'Estoy en proceso de mejorar mi CV y tengo una lista de empresas que me interesan.',
            'Me siento seguro/a con mi CV y ya estoy aplicando a vacantes o prepar√°ndome para entrevistas.',
            'Totalmente preparado/a; ya estoy en procesos de entrevista, tengo una oferta o ya consegu√≠ pr√°cticas.'
          ]
        }
      ]
    };

    const resolvedQuestionBank =
      questionBank && typeof questionBank === 'object' && Object.keys(questionBank).length > 0
        ? questionBank
        : FALLBACK_QUESTION_BANK;

    let selectedStage        = '';
    let currentQuestionIndex = 0;
    let activeQuestions      = [];
    let quizStartedAt        = null;
    const userAnswers        = {};
    let gateCheckInProgress  = false;

    const attemptsUsed = Number((responseStats && responseStats.count) || 0);
    const rawMaxAttempts = Number(responseStats && responseStats.maxAllowed);
    const maxAttempts = Number.isFinite(rawMaxAttempts) && rawMaxAttempts > 0 ? rawMaxAttempts : 1;
    let isLockedByAttempts = attemptsUsed >= maxAttempts;
    if (attemptCopy && attemptsUsed > 0) {
      attemptCopy.textContent = `Esta br√∫jula se responde una sola vez para trabajar con tu perfil real junto a tu mentora.`;
    } else if (attemptCopy) {
      attemptCopy.style.display = 'none';
    }

    const snapshotItems = [];
    if (studentProfile && studentProfile.matricula) snapshotItems.push(`Matr√≠cula: ${studentProfile.matricula}`);
    if (studentProfile && studentProfile.semestre) snapshotItems.push(`Semestre: ${studentProfile.semestre}`);
    if (studentProfile && studentProfile.promedio_acumulado) snapshotItems.push(`Promedio acumulado: ${studentProfile.promedio_acumulado}`);
    if (studentProfile && studentProfile.horas_servicio_social) snapshotItems.push(`Horas de servicio social: ${studentProfile.horas_servicio_social}`);
    if (studentProfile && studentProfile.nivel_ingles) snapshotItems.push(`Nivel de ingl√©s: ${studentProfile.nivel_ingles}`);
    if (studentProfile && studentProfile.requisito_ingles) snapshotItems.push(`Requisito de ingl√©s: ${studentProfile.requisito_ingles}`);
    if (snapshotItems.length) {
      snapshotItems.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        profileSnapshotList.appendChild(li);
      });
      profileSnapshot.style.display = 'block';
    }

    function renderAlreadyState(lastResponse) {
      const last = lastResponse || {};
      const hasScenario = !!last.profile_scenario;
      const hasScore = last.score_total != null && String(last.score_total).trim() !== '';
      const hasStage = !!(last.stage_label || last.stage);

      welcomeState.classList.add('hidden');
      quizState.classList.add('hidden');
      finalState.classList.add('hidden');
      alreadyState.classList.remove('hidden');

      if (hasScenario && hasScore) {
        const scenario = last.profile_scenario;
        alreadyChip.textContent = SCENARIO_LABELS[scenario] || scenario;
        alreadyChip.style.display = 'inline-flex';
        alreadyScore.textContent = `${last.score_total}/100`;
        alreadyScore.style.display = 'inline-flex';
      } else {
        alreadyChip.style.display = 'none';
        alreadyScore.style.display = 'none';
      }

      if (hasStage && hasScore) {
        const stageLabel = last.stage_label || last.stage;
        alreadyCopy.textContent = `Ya completaste esta br√∫jula. √öltimo registro: etapa ${stageLabel}, puntaje ${last.score_total}/100. Tu mentora ya tiene tu perfil visible.`;
      } else {
        alreadyCopy.textContent = 'Ya completaste esta br√∫jula. Tu mentora ya tiene tu perfil visible.';
      }
    }

    /* ‚îÄ‚îÄ ATTEMPT LIMIT CHECK ‚îÄ‚îÄ */
    if (isLockedByAttempts) {
      renderAlreadyState(previousResponse || {});
    }

    // Guard in real-time with backend data to avoid stale/client-cached stats.
    if (student && student.email && google && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler((gate) => {
          const gateCount = Number(gate && gate.count);
          const gateMaxRaw = Number(gate && gate.maxAllowed);
          const gateMax = Number.isFinite(gateMaxRaw) && gateMaxRaw > 0 ? gateMaxRaw : 1;
          if (gateCount >= gateMax) {
            isLockedByAttempts = true;
            renderAlreadyState((gate && gate.last) || previousResponse || {});
          }
        })
        .withFailureHandler(() => {})
        .getResponseGateStatus(student.email);
    }

    function checkGateBeforeStart(onAllowed) {
      if (isLockedByAttempts) {
        renderAlreadyState(previousResponse || {});
        return;
      }
      if (gateCheckInProgress) return;
      gateCheckInProgress = true;
      startBtn.disabled = true;

      google.script.run
        .withSuccessHandler((gate) => {
          gateCheckInProgress = false;
          const gateCount = Number(gate && gate.count);
          const gateMaxRaw = Number(gate && gate.maxAllowed);
          const gateMax = Number.isFinite(gateMaxRaw) && gateMaxRaw > 0 ? gateMaxRaw : 1;
          if (gateCount >= gateMax) {
            isLockedByAttempts = true;
            renderAlreadyState((gate && gate.last) || previousResponse || {});
            return;
          }
          if (typeof onAllowed === 'function') onAllowed();
        })
        .withFailureHandler((error) => {
          gateCheckInProgress = false;
          console.error(error);
          // Conservative fallback: avoid opening quiz if gate check failed.
          finalState.classList.remove('hidden');
          finalLoading.classList.add('hidden');
          finalContent.classList.add('hidden');
          errorMessage.textContent = 'No pudimos validar tu acceso al test en este momento. Recarga e intenta de nuevo.';
          errorMessage.classList.remove('hidden');
        })
        .getResponseGateStatus(student.email);
    }

    function applyStageSelection(stage) {
      selectedStage = stage || '';
      document.querySelectorAll('.stage-card').forEach((el) => {
        const isSelected = el.dataset.stage === selectedStage;
        el.classList.toggle('selected', isSelected);
        el.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
      });
      startBtn.disabled = !selectedStage;
    }

    /* ‚îÄ‚îÄ STAGE CARD SELECTION ‚îÄ‚îÄ */
    document.querySelectorAll('.stage-card').forEach((card) => {
      card.addEventListener('click', () => applyStageSelection(card.dataset.stage));
    });

    /* ‚îÄ‚îÄ START TEST ‚îÄ‚îÄ */
    startBtn.addEventListener('click', () => {
      if (!selectedStage) return;
      checkGateBeforeStart(() => {
        activeQuestions = resolvedQuestionBank[selectedStage] || [];
        if (!activeQuestions.length) {
          finalState.classList.remove('hidden');
          finalLoading.classList.add('hidden');
          finalContent.classList.add('hidden');
          errorMessage.classList.remove('hidden');
          return;
        }
        quizStartedAt = new Date();
        currentQuestionIndex = 0;
        welcomeState.classList.add('hidden');
        quizState.classList.remove('hidden');
        renderQuestion();
      });
    });

    /* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ */
    prevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex -= 1;
        renderQuestion();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentQuestionIndex < activeQuestions.length - 1) {
        currentQuestionIndex += 1;
        renderQuestion();
      } else {
        submitAnswers();
      }
    });

    function resetQuizToWelcome() {
      Object.keys(userAnswers).forEach((key) => delete userAnswers[key]);
      quizStartedAt = null;
      currentQuestionIndex = 0;
      quizState.classList.add('hidden');
      welcomeState.classList.remove('hidden');
    }

    changeStageBtn.addEventListener('click', () => {
      const hasAnswered = Object.keys(userAnswers).length > 0;
      if (!hasAnswered) {
        resetQuizToWelcome();
        return;
      }
      changeStageModal.classList.remove('hidden');
      modalCancelBtn.focus();
    });
    modalCancelBtn.addEventListener('click', () => changeStageModal.classList.add('hidden'));
    modalConfirmBtn.addEventListener('click', () => {
      changeStageModal.classList.add('hidden');
      resetQuizToWelcome();
    });

    /* ‚îÄ‚îÄ RENDER QUESTION ‚îÄ‚îÄ */
    function renderQuestion() {
      const question = activeQuestions[currentQuestionIndex];
      if (!question) return;

      let html = `<h2 class="question-title">${addQuestionMarks(question.title)}</h2>
                  <div class="answer-list" role="group" aria-label="Opciones de respuesta">`;

      question.options.forEach((option, idx) => {
        const value   = idx + 1;
        const pressed = userAnswers[question.key] === value;
        /* Stagger delay: each option appears 60 ms after the previous */
        html += `<button
          data-value="${value}"
          class="answer-btn"
          type="button"
          aria-pressed="${pressed}"
          style="animation-delay:${idx * 60}ms"
        >${option}</button>`;
      });

      html += '</div>';
      questionContainer.innerHTML = html;

      document.querySelectorAll('.answer-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const val = Number(btn.dataset.value);
          userAnswers[question.key] = val;

          document.querySelectorAll('.answer-btn').forEach((node) => {
            node.setAttribute('aria-pressed', 'false');
          });
          btn.setAttribute('aria-pressed', 'true');
          nextBtn.disabled = false;
        });
      });

      updateQuizUi();
    }

    /* Injects Spanish opening question mark when missing. */
    function addQuestionMarks(text) {
      const t = text.trim();
      if (t.indexOf('¬ø') !== -1 || t.startsWith('¬°')) return t;
      const capitalized = t.charAt(0).toUpperCase() + t.slice(1);
      const withClose   = capitalized.endsWith('?') ? capitalized : capitalized + '?';
      return '¬ø' + withClose;
    }

    function updateQuizUi() {
      const total   = activeQuestions.length;
      const current = currentQuestionIndex + 1;
      const pct     = Math.round((currentQuestionIndex / total) * 100);

      progressBar.style.width = `${pct}%`;
      progressBarWrap.setAttribute('aria-valuenow', pct);
      progressBarWrap.setAttribute('aria-valuetext', `Pregunta ${current} de ${total}`);
      progressLabel.textContent = `${selectedStage === 'enfoque' ? 'Enfoque' : 'Exploraci√≥n'} ¬∑ ${current}/${total}`;
      prevBtn.style.display = currentQuestionIndex === 0 ? 'none' : 'inline-block';

      const isLast              = currentQuestionIndex === total - 1;
      nextBtn.textContent       = isLast ? 'Ver mis resultados ‚Üí' : 'Siguiente ‚Üí';
      nextBtn.setAttribute('aria-label', isLast ? 'Enviar respuestas y ver mi diagn√≥stico' : 'Ir a la pregunta siguiente');

      const currentKey  = activeQuestions[currentQuestionIndex].key;
      nextBtn.disabled  = !userAnswers[currentKey];
    }

    /* ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ */
    function submitAnswers() {
      quizState.classList.add('hidden');
      finalState.classList.remove('hidden');
      finalLoading.classList.remove('hidden');
      finalContent.classList.add('hidden');
      errorMessage.classList.add('hidden');
      let hasResolved = false;
      const submitTimeout = setTimeout(() => {
        if (hasResolved) return;
        hasResolved = true;
        finalLoading.classList.add('hidden');
        errorMessage.classList.remove('hidden');
      }, 12000);

      const payload = {
        student,
        stage:        selectedStage,
        stageContext: STAGE_CONTEXT_MAP[selectedStage] || selectedStage,
        answers:      userAnswers,
        clientMetrics: {
          quizStartedAt: quizStartedAt ? quizStartedAt.toISOString() : '',
          quizCompletedAt: new Date().toISOString(),
          completionSeconds: quizStartedAt ? Math.max(0, Math.round((Date.now() - quizStartedAt.getTime()) / 1000)) : ''
        }
      };

      google.script.run
        .withSuccessHandler((response) => {
          if (hasResolved) return;
          hasResolved = true;
          clearTimeout(submitTimeout);
          finalLoading.classList.add('hidden');
          finalContent.classList.remove('hidden');
          finalTitle.focus();

          scenarioChip.textContent  = SCENARIO_LABELS[response.scenario] || response.scenario;
          scoreRing.textContent     = `${response.scoreTotal}/100`;
          resultCopy.textContent    = SCENARIO_MESSAGES[response.scenario]
                                      || 'Tu mentora revisar√° tu perfil antes de la reuni√≥n.';
        })
        .withFailureHandler((error) => {
          if (hasResolved) return;
          hasResolved = true;
          clearTimeout(submitTimeout);
          console.error(error);
          const rawMsg = (error && error.message) ? String(error.message) : '';
          if (rawMsg.indexOf('Ya registraste tu respuesta') !== -1) {
            renderAlreadyState(previousResponse || {});
            return;
          }
          errorMessage.textContent = mapUserFacingError(rawMsg);
          finalLoading.classList.add('hidden');
          errorMessage.classList.remove('hidden');
        })
        .processWebAppSubmission(payload);
    }

    function mapUserFacingError(rawMsg) {
      const clean = String(rawMsg || '').replace(/^Error:\s*/i, '');
      if (!clean) return 'Algo sali√≥ mal al guardar. Recarga la p√°gina o escr√≠bele directamente a tu mentora.';
      if (clean.indexOf('Ya registraste tu respuesta') !== -1) return clean;
      if (clean.indexOf('Payload incompleto') !== -1) return 'Algo sali√≥ mal al enviar. Recarga la p√°gina e intenta de nuevo.';
      return 'Algo sali√≥ mal al guardar. Recarga la p√°gina o escr√≠bele directamente a tu mentora.';
    }
  </script>
</body>
</html>
